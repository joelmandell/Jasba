@page "/Tenant/FloorPlans/{FloorPlanId:guid}/Edit"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using SBAPro.Core.Entities
@using SBAPro.Infrastructure.Data
@using SBAPro.Core.Interfaces
@using Microsoft.Extensions.Localization
@attribute [Authorize(Roles = "TenantAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ITenantService TenantService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResources> Localizer
@implements IAsyncDisposable

<PageTitle>@Localizer["EditFloorPlan"] - SBA Pro</PageTitle>

<!-- Include Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="flex-grow-1">
        @if (isEditingName)
        {
            <div class="d-flex align-items-center">
                <input type="text" class="form-control me-2" style="max-width: 400px;" @bind="editedFloorPlanName" />
                <button class="btn btn-sm btn-success me-1" @onclick="SaveFloorPlanName">
                    <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-secondary" @onclick="CancelEditName">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        }
        else
        {
            <h3 class="d-inline">@floorPlanName</h3>
            <button class="btn btn-sm btn-link" @onclick="StartEditName">
                <i class="bi bi-pencil"></i>
            </button>
        }
    </div>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="editModeToggle" @bind="isEditMode" @bind:after="ToggleEditMode">
        <label class="form-check-label" for="editModeToggle">
            @Localizer["EditMode"]
        </label>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <strong>@Localizer["FloorPlan"]</strong>
                <small class="text-muted">
                    @if (isEditMode)
                    {
                        <span>@Localizer["EditModeHint"]</span>
                    }
                    else
                    {
                        <span>@Localizer["ClickToPlaceObjects"]</span>
                    }
                </small>
            </div>
            <div class="card-body">
                <div id="floorPlanMap" style="height: 600px; width: 100%;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        @if (showObjectForm)
        {
            <div class="card">
                <div class="card-header">Add Inspection Object</div>
                <div class="card-body">
                    <EditForm Model="newObject" OnValidSubmit="SaveObject">
                        <div class="mb-3">
                            <label class="form-label">Object Type</label>
                            <select class="form-control" @bind="newObject.TypeId">
                                <option value="">Select type...</option>
                                @foreach (var type in objectTypes ?? new())
                                {
                                    <option value="@type.Id">@type.Icon @type.Name</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputText class="form-control" @bind-Value="newObject.Description" />
                        </div>
                        <button type="submit" class="btn btn-success">Save</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelAdd">Cancel</button>
                    </EditForm>
                </div>
            </div>
        }

        <div class="card mt-3">
            <div class="card-header">Inspection Objects (@objects?.Count ?? 0)</div>
            <div class="card-body">
                @if (objects != null && objects.Any())
                {
                    <div class="list-group">
                        @foreach (var obj in objects)
                        {
                            <div class="list-group-item">
                                <strong>@obj.Type.Icon @obj.Type.Name</strong><br />
                                <small>@obj.Description</small>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No objects yet. Click on the map to add one.</p>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Guid FloorPlanId { get; set; }

    private FloorPlan? floorPlan;
    private string floorPlanName = "";
    private string editedFloorPlanName = "";
    private bool isEditingName = false;
    private bool isEditMode = false;
    private List<InspectionObject>? objects;
    private List<InspectionObjectType>? objectTypes;
    private bool showObjectForm = false;
    private InspectionObject newObject = new();
    private double clickedX = 0;
    private double clickedY = 0;
    private IJSObjectReference? module;
    private DotNetObjectReference<FloorPlanEditor>? dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadFloorPlan();
        await LoadObjectTypes();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && floorPlan != null)
        {
            await InitializeMap();
        }
    }

    private async Task LoadFloorPlan()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        floorPlan = await context.FloorPlans
            .Include(fp => fp.InspectionObjects)
                .ThenInclude(io => io.Type)
            .FirstOrDefaultAsync(fp => fp.Id == FloorPlanId);

        if (floorPlan != null)
        {
            floorPlanName = floorPlan.Name;
            objects = floorPlan.InspectionObjects.ToList();
        }
    }

    private async Task LoadObjectTypes()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        objectTypes = await context.InspectionObjectTypes.ToListAsync();
    }

    private async Task InitializeMap()
    {
        if (floorPlan == null) return;

        try
        {
            module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/leafletMap.js");

            // Check if floor plan has an image
            string? imageUrl = null;
            if (floorPlan.ImageData != null && !string.IsNullOrEmpty(floorPlan.ImageMimeType))
            {
                // Convert image to data URL
                imageUrl = $"data:{floorPlan.ImageMimeType};base64,{Convert.ToBase64String(floorPlan.ImageData)}";
            }

            // Initialize map (with or without image)
            await module.InvokeVoidAsync("initializeMap", "floorPlanMap", imageUrl, 
                floorPlan.ImageWidth, floorPlan.ImageHeight);

            // Add existing markers
            foreach (var obj in objects ?? new())
            {
                await module.InvokeVoidAsync("addMarker", "floorPlanMap", 
                    obj.NormalizedX, obj.NormalizedY,
                    floorPlan.ImageWidth, floorPlan.ImageHeight,
                    obj.Id.ToString(), obj.Type.Name, obj.Description);
            }

            // Set up click handler
            dotNetRef = DotNetObjectReference.Create(this);
            await module.InvokeVoidAsync("onMapClick", "floorPlanMap", dotNetRef,
                floorPlan.ImageWidth, floorPlan.ImageHeight);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing map: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMapClicked(double x, double y)
    {
        // Only allow adding objects when not in edit mode
        if (!isEditMode)
        {
            await InvokeAsync(() =>
            {
                clickedX = x;
                clickedY = y;
                showObjectForm = true;
                StateHasChanged();
            });
        }
    }

    [JSInvokable]
    public async Task OnMarkerMoved(string objectId, double x, double y)
    {
        if (!isEditMode) return;

        using var context = await DbFactory.CreateDbContextAsync();
        var objGuid = Guid.Parse(objectId);
        var obj = await context.InspectionObjects.FirstOrDefaultAsync(o => o.Id == objGuid);
        
        if (obj != null)
        {
            obj.NormalizedX = x;
            obj.NormalizedY = y;
            await context.SaveChangesAsync();
        }
    }

    private void StartEditName()
    {
        editedFloorPlanName = floorPlanName;
        isEditingName = true;
    }

    private async Task SaveFloorPlanName()
    {
        if (string.IsNullOrWhiteSpace(editedFloorPlanName))
        {
            CancelEditName();
            return;
        }

        using var context = await DbFactory.CreateDbContextAsync();
        var fp = await context.FloorPlans.FirstOrDefaultAsync(f => f.Id == FloorPlanId);
        
        if (fp != null)
        {
            fp.Name = editedFloorPlanName.Trim();
            await context.SaveChangesAsync();
            floorPlanName = fp.Name;
        }

        isEditingName = false;
    }

    private void CancelEditName()
    {
        isEditingName = false;
        editedFloorPlanName = "";
    }

    private async Task ToggleEditMode()
    {
        if (module != null)
        {
            await module.InvokeVoidAsync("setEditMode", "floorPlanMap", isEditMode, dotNetRef, 
                floorPlan?.ImageWidth ?? 1000, floorPlan?.ImageHeight ?? 800);
        }
    }

    private async Task SaveObject()
    {
        if (floorPlan == null) return;

        using var context = await DbFactory.CreateDbContextAsync();

        var inspectionObject = new InspectionObject
        {
            Id = Guid.NewGuid(),
            TypeId = newObject.TypeId,
            Description = newObject.Description,
            FloorPlanId = FloorPlanId,
            NormalizedX = clickedX,
            NormalizedY = clickedY
        };

        context.InspectionObjects.Add(inspectionObject);
        await context.SaveChangesAsync();

        // Add marker to map
        var objType = objectTypes?.FirstOrDefault(t => t.Id == inspectionObject.TypeId);
        if (module != null && objType != null)
        {
            await module.InvokeVoidAsync("addMarker", "floorPlanMap",
                inspectionObject.NormalizedX, inspectionObject.NormalizedY,
                floorPlan.ImageWidth, floorPlan.ImageHeight,
                inspectionObject.Id.ToString(), objType.Name, inspectionObject.Description);
        }

        showObjectForm = false;
        await LoadFloorPlan();
    }

    private void CancelAdd()
    {
        showObjectForm = false;
        newObject = new();
    }

    public async ValueTask DisposeAsync()
    {
        if (module != null)
        {
            await module.DisposeAsync();
        }
        dotNetRef?.Dispose();
    }
}
