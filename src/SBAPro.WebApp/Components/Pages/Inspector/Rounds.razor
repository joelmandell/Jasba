@page "/Inspector/Rounds"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using SBAPro.Core.Entities
@using SBAPro.Core.Interfaces
@using SBAPro.Infrastructure.Data
@attribute [Authorize(Roles = "Inspector,TenantAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IReportGenerator ReportGenerator
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["InspectionRounds"] - @Localizer["AppName"]</PageTitle>

<div class="content">
    <div class="mb-4 flex justify-between items-center">
        <h3 class="text-2xl font-bold">@Localizer["InspectionRounds"]</h3>
        <a href="/Inspector/StartRound" class="btn btn-primary">
            @Localizer["StartNewRound"]
        </a>
    </div>

    @if (rounds != null)
    {
        @if (rounds.Count == 0)
        {
            <div class="alert alert-info">
                @Localizer["NoRoundsFound"]
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body" style="padding: 0;">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>@Localizer["Site"]</th>
                                <th>@Localizer["Started"]</th>
                                <th>@Localizer["Completed"]</th>
                                <th>@Localizer["Status"]</th>
                                <th>@Localizer["Results"]</th>
                                <th>@Localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var round in rounds)
                            {
                                <tr>
                                    <td>@round.Site.Name</td>
                                    <td>@round.StartedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@(round.CompletedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                    <td>
                                        @if (round.Status == InspectionRoundStatus.Completed)
                                        {
                                            <span class="badge badge-success">@Localizer["Completed"]</span>
                                        }
                                        else if (round.Status == InspectionRoundStatus.InProgress)
                                        {
                                            <span class="badge badge-info">@Localizer["InProgress"]</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-warning">@round.Status</span>
                                        }
                                    </td>
                                    <td>@round.InspectionResults.Count @Localizer["Items"]</td>
                                    <td>
                                        @if (round.Status != InspectionRoundStatus.Completed)
                                        {
                                            <a href="/Inspector/Execute/@round.Id" class="btn btn-sm btn-primary">
                                                @Localizer["Continue"]
                                            </a>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-success" @onclick="() => DownloadReport(round.Id)">
                                                @Localizer["DownloadPDFReport"]
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
    else
    {
        <p>Loading inspection rounds...</p>
    }
</div>

@code {
    private List<InspectionRound>? rounds;

    protected override async Task OnInitializedAsync()
    {
        await LoadRounds();
    }

    private async Task LoadRounds()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        rounds = await context.InspectionRounds
            .Include(r => r.Site)
            .Include(r => r.InspectionResults)
            .OrderByDescending(r => r.StartedAt)
            .ToListAsync();
    }

    private async Task DownloadReport(Guid roundId)
    {
        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            var round = await context.InspectionRounds
                .Include(r => r.Site)
                .Include(r => r.Inspector)
                .Include(r => r.InspectionResults)
                    .ThenInclude(ir => ir.Object)
                        .ThenInclude(o => o.Type)
                .FirstOrDefaultAsync(r => r.Id == roundId);

            if (round == null)
            {
                Console.WriteLine("Round not found");
                return;
            }

            var pdfBytes = await ReportGenerator.GenerateInspectionReportAsync(round);
            var base64 = Convert.ToBase64String(pdfBytes);
            
            await JSRuntime.InvokeVoidAsync("downloadPdf", base64, $"rapport_{roundId}.pdf");
        }
        catch (Exception ex)
        {
            // Handle error - could add error message display here
            Console.WriteLine($"Error downloading report: {ex.Message}");
        }
    }
}
