@page "/Admin/Tenants"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using SBAPro.Core.Entities
@using SBAPro.Infrastructure.Data
@attribute [Authorize(Roles = "SystemAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["TenantManagement"] - @Localizer["AppName"]</PageTitle>

<h3>@Localizer["TenantManagement"]</h3>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowCreateForm">@Localizer["CreateNewTenant"]</button>
</div>

@if (showCreateForm)
{
    <div class="card mb-3">
        <div class="card-header">@Localizer["CreateNewTenant"]</div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    @errorMessage
                </div>
            }
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    @successMessage
                </div>
            }
            <EditForm Model="newTenant" OnValidSubmit="CreateTenant">
                <div class="mb-3">
                    <label class="form-label">@Localizer["TenantName"]</label>
                    <InputText class="form-control" @bind-Value="newTenant.Name" />
                </div>
                <div class="mb-3">
                    <label class="form-label">@Localizer["AdminEmail"]</label>
                    <InputText class="form-control" @bind-Value="newTenant.AdminEmail" />
                </div>
                <div class="mb-3">
                    <label class="form-label">@Localizer["AdminPassword"]</label>
                    <InputText type="password" class="form-control" @bind-Value="newTenant.AdminPassword" />
                </div>
                <button type="submit" class="btn btn-success">@Localizer["Create"]</button>
                <button type="button" class="btn btn-secondary" @onclick="() => showCreateForm = false">@Localizer["Cancel"]</button>
            </EditForm>
        </div>
    </div>
}

@if (tenants != null)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@Localizer["Name"]</th>
                <th>@Localizer["ID"]</th>
                <th>@Localizer["Users"]</th>
                <th>@Localizer["Sites"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var tenant in tenants)
            {
                <tr>
                    <td>@tenant.Name</td>
                    <td><small>@tenant.Id</small></td>
                    <td>@tenant.Users.Count</td>
                    <td>@tenant.Sites.Count</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Tenant>? tenants;
    private bool showCreateForm = false;
    private CreateTenantModel newTenant = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenants();
    }

    private async Task LoadTenants()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        tenants = await context.Tenants
            .IgnoreQueryFilters()
            .Include(t => t.Users)
            .Include(t => t.Sites)
            .ToListAsync();
    }

    private void ShowCreateForm()
    {
        showCreateForm = true;
        newTenant = new CreateTenantModel();
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();
    }

    private async Task CreateTenant()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        
        try
        {
            Tenant tenant;
            
            // First, create the tenant
            using (var context = await DbFactory.CreateDbContextAsync())
            {
                tenant = new Tenant
                {
                    Id = Guid.NewGuid(),
                    Name = newTenant.Name
                };

                context.Tenants.Add(tenant);
                await context.SaveChangesAsync();
            }

            // Then, create the tenant admin user in a separate transaction
            // This ensures the tenant is fully committed before creating the user
            var adminUser = new ApplicationUser
            {
                UserName = newTenant.AdminEmail,
                Email = newTenant.AdminEmail,
                EmailConfirmed = true,
                TenantId = tenant.Id
            };

            var result = await UserManager.CreateAsync(adminUser, newTenant.AdminPassword);
            if (result.Succeeded)
            {
                await UserManager.AddToRoleAsync(adminUser, "TenantAdmin");
                successMessage = $"Tenant '{tenant.Name}' and admin user created successfully!";
                await Task.Delay(2000); // Show success message briefly
                showCreateForm = false;
                await LoadTenants();
            }
            else
            {
                // Show user creation errors
                errorMessage = "Failed to create admin user: " + string.Join(", ", result.Errors.Select(e => e.Description));
                
                // Also log to console for debugging
                foreach (var error in result.Errors)
                {
                    Console.WriteLine($"Error creating user: {error.Code} - {error.Description}");
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating tenant: {ex.Message}";
            Console.WriteLine($"Exception creating tenant: {ex}");
        }
    }

    public class CreateTenantModel
    {
        public string Name { get; set; } = string.Empty;
        public string AdminEmail { get; set; } = string.Empty;
        public string AdminPassword { get; set; } = string.Empty;
    }
}
