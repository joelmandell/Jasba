@page "/Inspector/StartRound"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@using SBAPro.Core.Entities
@using SBAPro.Infrastructure.Data
@attribute [Authorize(Roles = "Inspector,TenantAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["StartInspectionRound"] - @Localizer["AppName"]</PageTitle>

<div class="content">
    <h3 class="text-2xl font-bold mb-6">@Localizer["StartNewInspectionRound"]</h3>

    @if (message != null)
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success")">
            @message
        </div>
    }

    <div class="card">
        <div class="card-header">@Localizer["SelectSiteAndFloorPlan"]</div>
        <div class="card-body">
            @if (sites == null)
            {
                <p>@Localizer["LoadingSites"]</p>
            }
            else if (sites.Count == 0)
            {
                <div class="alert alert-info">
                    @Localizer["NoSitesAvailable"]
                </div>
            }
            else
            {
                <EditForm Model="this" OnValidSubmit="StartInspectionRound">
                    <div class="mb-3">
                        <label class="form-label">@Localizer["Site"]</label>
                        <select class="form-control form-select" @onchange="OnSiteSelected">
                            <option value="">@Localizer["SelectASite"]</option>
                            @foreach (var site in sites)
                            {
                                <option value="@site.Id">@site.Name - @site.Address</option>
                            }
                        </select>
                    </div>

                    @if (selectedSite != null)
                    {
                        <div class="mb-3">
                            <label class="form-label">@Localizer["FloorPlan"]</label>
                            @if (selectedSite.FloorPlans.Count == 0)
                            {
                                <div class="alert alert-warning">
                                    @Localizer["NoFloorPlans"]
                                </div>
                            }
                            else
                            {
                                <select class="form-control form-select" @onchange="OnFloorPlanSelected">
                                    <option value="">@Localizer["SelectAFloorPlan"]</option>
                                    @foreach (var fp in selectedSite.FloorPlans)
                                    {
                                        <option value="@fp.Id">@fp.Name (@fp.InspectionObjects.Count @Localizer["Objects"])</option>
                                    }
                                </select>
                            }
                        </div>

                        @if (selectedFloorPlan != null)
                        {
                            <div class="alert alert-info">
                                <strong>@Localizer["ReadyToStart"]</strong><br />
                                @string.Format(Localizer["ThisFloorPlanHasObjects"], selectedFloorPlan.InspectionObjects.Count)
                            </div>
                        }
                    }

                    <div class="mt-4">
                        <button type="submit" class="btn btn-success" disabled="@(selectedFloorPlan == null)">
                            @Localizer["StartRound"]
                        </button>
                        <a href="/Inspector/Rounds" class="btn btn-secondary">@Localizer["Cancel"]</a>
                    </div>
                </EditForm>
            }
        </div>
    </div>
</div>

@code {
    private List<Site>? sites;
    private Site? selectedSite;
    private Guid? selectedFloorPlanId;
    private FloorPlan? selectedFloorPlan;
    private string? message;
    private bool isError;

    protected override async Task OnInitializedAsync()
    {
        await LoadSites();
    }

    private async Task LoadSites()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        sites = await context.Sites
            .Include(s => s.FloorPlans)
                .ThenInclude(fp => fp.InspectionObjects)
                    .ThenInclude(io => io.Type)
            .ToListAsync();
    }

    private void OnSiteSelected(ChangeEventArgs e)
    {
        var siteIdStr = e.Value?.ToString();
        if (Guid.TryParse(siteIdStr, out var siteId))
        {
            selectedSite = sites?.FirstOrDefault(s => s.Id == siteId);
            selectedFloorPlanId = null;
            selectedFloorPlan = null;
        }
        else
        {
            selectedSite = null;
            selectedFloorPlanId = null;
            selectedFloorPlan = null;
        }
    }

    private void OnFloorPlanSelected(ChangeEventArgs e)
    {
        var floorPlanIdStr = e.Value?.ToString();
        if (Guid.TryParse(floorPlanIdStr, out var floorPlanId))
        {
            selectedFloorPlanId = floorPlanId;
            selectedFloorPlan = selectedSite?.FloorPlans.FirstOrDefault(fp => fp.Id == floorPlanId);
        }
        else
        {
            selectedFloorPlanId = null;
            selectedFloorPlan = null;
        }
    }

    private async Task StartInspectionRound()
    {
        if (selectedFloorPlan == null || selectedSite == null)
        {
            message = "Please select both a site and floor plan.";
            isError = true;
            return;
        }

        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            
            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            if (string.IsNullOrEmpty(userId))
            {
                message = "Could not determine current user.";
                isError = true;
                return;
            }

            // Create new inspection round
            var round = new InspectionRound
            {
                Id = Guid.NewGuid(),
                SiteId = selectedSite.Id,
                InspectorId = userId,
                StartedAt = DateTime.UtcNow,
                Status = InspectionRoundStatus.InProgress
            };

            context.InspectionRounds.Add(round);
            await context.SaveChangesAsync();

            // Navigate to the inspection execution page
            NavigationManager.NavigateTo($"/Inspector/Execute/{round.Id}");
        }
        catch (Exception ex)
        {
            message = $"Error starting round: {ex.Message}";
            isError = true;
        }
    }

    protected override void OnParametersSet()
    {
        if (selectedFloorPlanId.HasValue && selectedSite != null)
        {
            selectedFloorPlan = selectedSite.FloorPlans.FirstOrDefault(fp => fp.Id == selectedFloorPlanId.Value);
        }
    }
}
