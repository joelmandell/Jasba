@page "/mobile/execute/{RoundId:guid}"
@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using SBAPro.Core.Entities
@using SBAPro.Core.Interfaces
@using SBAPro.Infrastructure.Data
@attribute [Authorize(Roles = "Inspector,TenantAdmin,SystemAdmin")]
@layout MobileLayout
@rendermode InteractiveServer
@inject IStringLocalizer<SharedResources> Localizer
@inject NavigationManager NavigationManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ITenantService TenantService

<div class="mobile-execute">
    @if (isLoading)
    {
        <div class="loading">
            <p>@Localizer["LoadingInspectionRound"]...</p>
        </div>
    }
    else if (inspectionRound == null)
    {
        <div class="error">
            <p>@Localizer["InspectionRoundNotFound"]</p>
        </div>
    }
    else
    {
        <div class="round-info">
            <h2>@inspectionRound.Site.Name</h2>
            
            @if (floorPlans.Count > 1)
            {
                <div class="form-group">
                    <label>@Localizer["SelectFloor"]</label>
                    <select @bind="selectedFloorPlanId" @bind:after="FilterObjectsByFloor" class="form-select">
                        <option value="@Guid.Empty">@Localizer["AllFloors"]</option>
                        @foreach (var fp in floorPlans)
                        {
                            <option value="@fp.Id">@fp.Name</option>
                        }
                    </select>
                </div>
            }
            
            <div class="progress-bar">
                <div class="progress-fill" style="width: @GetProgressPercentage()%"></div>
            </div>
            <p class="progress-text">
                @inspectedCount / @totalObjects @Localizer["ObjectsInspected"]
            </p>
        </div>

        <div class="objects-list">
            @foreach (var obj in filteredObjects)
            {
                var result = GetInspectionResult(obj.Id);
                var isInspected = result != null;
                
                <div class="object-card @(isInspected ? "inspected" : "")" @onclick="() => OpenInspectionModal(obj)">
                    <div class="object-status">
                        @if (isInspected)
                        {
                            <span class="status-icon @GetStatusIconClass(result.Status)">
                                @GetStatusIcon(result.Status)
                            </span>
                        }
                        else
                        {
                            <span class="status-icon pending">‚ö™</span>
                        }
                    </div>
                    <div class="object-info">
                        <h3>@obj.Description</h3>
                        <p class="object-type">@obj.Type.Name</p>
                        @if (isInspected && !string.IsNullOrWhiteSpace(result.Comment))
                        {
                            <p class="object-comment">@result.Comment</p>
                        }
                    </div>
                    <div class="object-action">
                        <span class="action-icon">@(isInspected ? "‚úèÔ∏è" : "‚ñ∂Ô∏è")</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showModal && selectedObject != null)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@selectedObject.Description</h3>
                <button type="button" class="close-btn" @onclick="CloseModal">‚úï</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>@Localizer["Status"]</label>
                    <div class="status-buttons">
                        <button type="button" class="status-btn @(inspectionStatus == InspectionStatus.Ok ? "active ok" : "")"
                                @onclick='() => SetStatus(InspectionStatus.Ok)'>
                            <span class="btn-icon">‚úÖ</span>
                            <span>@Localizer["Ok"]</span>
                        </button>
                        <button type="button" class="status-btn @(inspectionStatus == InspectionStatus.Deficient ? "active deficient" : "")"
                                @onclick='() => SetStatus(InspectionStatus.Deficient)'>
                            <span class="btn-icon">‚ö†Ô∏è</span>
                            <span>@Localizer["Deficient"]</span>
                        </button>
                        <button type="button" class="status-btn @(inspectionStatus == InspectionStatus.NotAccessible ? "active not-accessible" : "")"
                                @onclick='() => SetStatus(InspectionStatus.NotAccessible)'>
                            <span class="btn-icon">üö´</span>
                            <span>@Localizer["NotAccessible"]</span>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>@Localizer["Comment"] (@Localizer["Optional"])</label>
                    <textarea @bind="inspectionComment" 
                              rows="4" 
                              placeholder="@Localizer["EnterComment"]"></textarea>
                </div>

                <div class="form-group">
                    <label>@Localizer["Photo"] (@Localizer["Optional"])</label>
                    
                    @if (existingPhotoData != null)
                    {
                        <div class="photo-preview">
                            <img src="@GetPhotoDataUrl()" alt="Inspection photo" />
                            <button type="button" class="btn-remove-photo" @onclick="RemovePhoto">
                                üóëÔ∏è @Localizer["RemovePhoto"]
                            </button>
                        </div>
                    }
                    
                    <InputFile OnChange="HandlePhotoSelected" accept="image/*" capture="environment" class="file-input" />
                    
                    @if (!string.IsNullOrEmpty(photoUploadMessage))
                    {
                        <div class="upload-message">@photoUploadMessage</div>
                    }
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                    @Localizer["Cancel"]
                </button>
                <button type="button" class="btn btn-primary" @onclick="SaveInspection" disabled="@(inspectionStatus == null)">
                    @Localizer["SaveInspection"]
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid RoundId { get; set; }

    private InspectionRound? inspectionRound;
    private List<InspectionObject> objects = new();
    private List<InspectionObject> filteredObjects = new();
    private List<FloorPlan> floorPlans = new();
    private List<InspectionResult> results = new();
    private bool isLoading = true;
    private int inspectedCount = 0;
    private int totalObjects = 0;
    private Guid selectedFloorPlanId = Guid.Empty;

    private bool showModal = false;
    private InspectionObject? selectedObject;
    private InspectionStatus? inspectionStatus;
    private string? inspectionComment;
    private byte[]? existingPhotoData;
    private string? existingPhotoMimeType;
    private byte[]? newPhotoData;
    private string? newPhotoMimeType;
    private string? photoUploadMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadInspectionRound();
    }

    private async Task LoadInspectionRound()
    {
        isLoading = true;
        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            
            inspectionRound = await context.InspectionRounds
                .Include(r => r.Site)
                .ThenInclude(s => s.FloorPlans)
                .ThenInclude(fp => fp.InspectionObjects)
                .ThenInclude(o => o.Type)
                .Include(r => r.InspectionResults)
                .FirstOrDefaultAsync(r => r.Id == RoundId);

            if (inspectionRound != null)
            {
                floorPlans = inspectionRound.Site.FloorPlans.OrderBy(fp => fp.Name).ToList();
                
                objects = inspectionRound.Site.FloorPlans
                    .SelectMany(fp => fp.InspectionObjects)
                    .OrderBy(o => o.Description)
                    .ToList();

                FilterObjectsByFloor();

                results = inspectionRound.InspectionResults.ToList();
                totalObjects = filteredObjects.Count;
                inspectedCount = results.Count(r => filteredObjects.Any(o => o.Id == r.ObjectId));
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private InspectionResult? GetInspectionResult(Guid objectId)
    {
        return results.FirstOrDefault(r => r.ObjectId == objectId);
    }

    private void OpenInspectionModal(InspectionObject obj)
    {
        selectedObject = obj;
        var existingResult = GetInspectionResult(obj.Id);
        inspectionStatus = existingResult?.Status;
        inspectionComment = existingResult?.Comment;
        existingPhotoData = existingResult?.PhotoData;
        existingPhotoMimeType = existingResult?.PhotoMimeType;
        newPhotoData = null;
        newPhotoMimeType = null;
        photoUploadMessage = null;
        showModal = true;
    }

    private void SetStatus(InspectionStatus status)
    {
        inspectionStatus = status;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        selectedObject = null;
        inspectionStatus = null;
        inspectionComment = null;
        existingPhotoData = null;
        existingPhotoMimeType = null;
        newPhotoData = null;
        newPhotoMimeType = null;
        photoUploadMessage = null;
    }

    private async Task SaveInspection()
    {
        if (selectedObject == null || inspectionStatus == null)
            return;

        try
        {
            using var context = await DbFactory.CreateDbContextAsync();
            
            var existingResult = await context.InspectionResults
                .FirstOrDefaultAsync(r => r.RoundId == RoundId && r.ObjectId == selectedObject.Id);

            if (existingResult != null)
            {
                existingResult.Status = inspectionStatus.Value;
                existingResult.Comment = inspectionComment;
                existingResult.Timestamp = DateTime.UtcNow;
                
                // Update photo if new one was uploaded, or clear if removed
                if (newPhotoData != null)
                {
                    existingResult.PhotoData = newPhotoData;
                    existingResult.PhotoMimeType = newPhotoMimeType;
                }
                else if (existingPhotoData == null)
                {
                    // Photo was removed
                    existingResult.PhotoData = null;
                    existingResult.PhotoMimeType = null;
                }
                
                context.InspectionResults.Update(existingResult);
            }
            else
            {
                var newResult = new InspectionResult
                {
                    Id = Guid.NewGuid(),
                    RoundId = RoundId,
                    ObjectId = selectedObject.Id,
                    Status = inspectionStatus.Value,
                    Comment = inspectionComment,
                    Timestamp = DateTime.UtcNow,
                    PhotoData = newPhotoData,
                    PhotoMimeType = newPhotoMimeType
                };
                context.InspectionResults.Add(newResult);
            }

            var changesSaved = await context.SaveChangesAsync();
            Console.WriteLine($"SaveInspection: {changesSaved} changes saved");
            
            CloseModal();
            await LoadInspectionRound();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving inspection: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private double GetProgressPercentage()
    {
        return totalObjects > 0 ? (inspectedCount * 100.0 / totalObjects) : 0;
    }

    private string GetStatusIconClass(InspectionStatus status)
    {
        return status switch
        {
            InspectionStatus.Ok => "ok",
            InspectionStatus.Deficient => "deficient",
            InspectionStatus.NotAccessible => "not-accessible",
            _ => ""
        };
    }

    private string GetStatusIcon(InspectionStatus status)
    {
        return status switch
        {
            InspectionStatus.Ok => "‚úÖ",
            InspectionStatus.Deficient => "‚ö†Ô∏è",
            InspectionStatus.NotAccessible => "üö´",
            _ => "‚ö™"
        };
    }

    private void FilterObjectsByFloor()
    {
        if (selectedFloorPlanId == Guid.Empty)
        {
            filteredObjects = objects.ToList();
        }
        else
        {
            filteredObjects = objects.Where(o => o.FloorPlanId == selectedFloorPlanId).ToList();
        }
        
        totalObjects = filteredObjects.Count;
        inspectedCount = results.Count(r => filteredObjects.Any(o => o.Id == r.ObjectId));
    }

    private async Task HandlePhotoSelected(InputFileChangeEventArgs e)
    {
        photoUploadMessage = null;
        
        try
        {
            var file = e.File;
            
            if (file.Size > 5 * 1024 * 1024) // 5MB limit
            {
                photoUploadMessage = Localizer["PhotoTooLarge"];
                return;
            }

            using var memoryStream = new MemoryStream();
            await file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(memoryStream);
            
            newPhotoData = memoryStream.ToArray();
            newPhotoMimeType = file.ContentType;
            existingPhotoData = newPhotoData; // Show preview immediately
            existingPhotoMimeType = newPhotoMimeType;
            
            photoUploadMessage = Localizer["PhotoUploaded"];
            StateHasChanged();
        }
        catch (Exception ex)
        {
            photoUploadMessage = $"{Localizer["PhotoUploadFailed"]}: {ex.Message}";
            Console.WriteLine($"Photo upload error: {ex.Message}");
        }
    }

    private void RemovePhoto()
    {
        existingPhotoData = null;
        existingPhotoMimeType = null;
        newPhotoData = null;
        newPhotoMimeType = null;
        photoUploadMessage = Localizer["PhotoRemoved"];
        StateHasChanged();
    }

    private string GetPhotoDataUrl()
    {
        if (existingPhotoData != null && !string.IsNullOrEmpty(existingPhotoMimeType))
        {
            var base64 = Convert.ToBase64String(existingPhotoData);
            return $"data:{existingPhotoMimeType};base64,{base64}";
        }
        return string.Empty;
    }
}
