@page "/Inspector/Execute/{RoundId:guid}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using SBAPro.Core.Entities
@using SBAPro.Infrastructure.Data
@attribute [Authorize(Roles = "Inspector,TenantAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResources> Localizer
@implements IAsyncDisposable

<PageTitle>@Localizer["ExecuteInspection"] - @Localizer["AppName"]</PageTitle>

<!-- Include Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="content">
    @if (round == null || floorPlan == null)
    {
        <p>@Localizer["LoadingInspectionRound"]</p>
    }
    else
    {
        <div class="mb-4 flex justify-between items-center">
            <div>
                <h3 class="text-2xl font-bold">@Localizer["InspectionRound"]</h3>
                <p class="text-muted">@round.Site.Name - @Localizer["Started"] @round.StartedAt.ToString("yyyy-MM-dd HH:mm")</p>
            </div>
            <div>
                <span class="badge badge-info">@round.Status</span>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <strong>@floorPlan.Name</strong>
                        <small class="text-muted ml-2">@Localizer["ClickObjectsToInspect"]</small>
                    </div>
                    <div class="card-body">
                        @if (floorPlan.ImageData == null)
                        {
                            <div style="height: 600px; width: 100%; background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                <div class="text-center text-muted">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="mb-3" viewBox="0 0 16 16" style="margin: 0 auto; opacity: 0.4;">
                                        <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                        <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                    </svg>
                                    <p>@Localizer["NoFloorPlanImage"]</p>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div id="inspectionMap" style="height: 600px; width: 100%;"></div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                @if (selectedObject != null)
                {
                    <div class="card mb-3">
                        <div class="card-header">Inspect: @selectedObject.Type.Icon @selectedObject.Type.Name</div>
                        <div class="card-body">
                            <p><strong>Description:</strong> @selectedObject.Description</p>
                            
                            @if (currentResult != null)
                            {
                                <div class="alert alert-success">
                                    Already inspected: @currentResult.Status
                                </div>
                            }

                            <EditForm Model="inspectionForm" OnValidSubmit="SaveInspection">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-control form-select" value="@inspectionForm.Status" @onchange="OnStatusChanged">
                                        <option value="@InspectionStatus.Ok">âœ“ OK</option>
                                        <option value="@InspectionStatus.Deficient">âš  Issue Found</option>
                                        <option value="@InspectionStatus.NotAccessible">ðŸ”’ Not Accessible</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">@Localizer["Comment"] (@Localizer["Optional"])</label>
                                    <textarea class="form-control" rows="3" value="@inspectionForm.Comment" @onchange="@((ChangeEventArgs e) => inspectionForm.Comment = e.Value?.ToString() ?? string.Empty)" placeholder="@Localizer["AddComment"]"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success w-full">@Localizer["SaveInspection"]</button>
                                <button type="button" class="btn btn-secondary w-full mt-2" @onclick="ClearSelection">@Localizer["Cancel"]</button>
                            </EditForm>
                        </div>
                    </div>
                }

                <div class="card">
                    <div class="card-header">
                        Progress: @inspectedCount / @totalObjects
                    </div>
                    <div class="card-body">
                        @if (objects != null && objects.Any())
                        {
                            <div class="mb-3">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-primary h-2.5 rounded-full" style="width: @progressPercentage%"></div>
                                </div>
                                <small class="text-muted">@progressPercentage% complete</small>
                            </div>

                            <div class="list-group" style="max-height: 400px; overflow-y: auto;">
                                @foreach (var obj in objects)
                                {
                                    var result = results.FirstOrDefault(r => r.ObjectId == obj.Id);
                                    var statusClass = result?.Status switch
                                    {
                                        InspectionStatus.Ok => "border-l-4 border-green-500",
                                        InspectionStatus.Deficient => "border-l-4 border-red-500",
                                        InspectionStatus.NotAccessible => "border-l-4 border-yellow-500",
                                        _ => ""
                                    };
                                    
                                    <div class="list-group-item @statusClass cursor-pointer" @onclick="() => SelectObject(obj)">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <strong>@obj.Type.Icon @obj.Type.Name</strong><br />
                                                <small>@obj.Description</small>
                                            </div>
                                            <div>
                                                @if (result != null)
                                                {
                                                    @if (result.Status == InspectionStatus.Ok)
                                                    {
                                                        <span class="badge badge-success">OK</span>
                                                    }
                                                    else if (result.Status == InspectionStatus.Deficient)
                                                    {
                                                        <span class="badge badge-danger">Issue</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-warning">@result.Status</span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Not checked</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                @if (inspectedCount == totalObjects && totalObjects > 0)
                {
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="alert alert-success">
                                <strong>@Localizer["AllObjectsInspected"]</strong>
                            </div>
                            <button class="btn btn-primary w-full" @onclick="CompleteRound">
                                @Localizer["CompleteRound"]
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid RoundId { get; set; }

    private InspectionRound? round;
    private FloorPlan? floorPlan;
    private List<InspectionObject>? objects;
    private List<InspectionResult> results = new();
    private InspectionObject? selectedObject;
    private InspectionResult? currentResult;
    private InspectionForm inspectionForm = new();
    private IJSObjectReference? module;
    private DotNetObjectReference<ExecuteRound>? dotNetRef;
    private int inspectedCount => results.Count;
    private int totalObjects => objects?.Count ?? 0;
    private int progressPercentage => totalObjects > 0 ? (inspectedCount * 100 / totalObjects) : 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadRound();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && floorPlan != null)
        {
            await InitializeMap();
        }
    }

    private async Task LoadRound()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        round = await context.InspectionRounds
            .Include(r => r.Site)
                .ThenInclude(s => s.FloorPlans)
                    .ThenInclude(fp => fp.InspectionObjects)
                        .ThenInclude(io => io.Type)
            .Include(r => r.InspectionResults)
                .ThenInclude(ir => ir.Object)
                    .ThenInclude(io => io.Type)
            .FirstOrDefaultAsync(r => r.Id == RoundId);

        if (round == null) return;

        // Get the first floor plan for the site (or you may want to select a specific one)
        floorPlan = round.Site.FloorPlans.FirstOrDefault();

        if (floorPlan != null)
        {
            objects = floorPlan.InspectionObjects.ToList();
            results = round.InspectionResults.ToList();
        }
    }

    private async Task InitializeMap()
    {
        if (floorPlan == null || floorPlan.ImageData == null) return;

        try
        {
            module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/inspectionMap.js");

            var imageUrl = $"data:{floorPlan.ImageMimeType};base64,{Convert.ToBase64String(floorPlan.ImageData)}";

            await module.InvokeVoidAsync("initializeInspectionMap", "inspectionMap", imageUrl,
                floorPlan.ImageWidth, floorPlan.ImageHeight);

            // Add markers for all objects
            foreach (var obj in objects ?? new())
            {
                var result = results.FirstOrDefault(r => r.ObjectId == obj.Id);
                var status = result?.Status.ToString() ?? "NotInspected";
                
                await module.InvokeVoidAsync("addInspectionMarker", "inspectionMap",
                    obj.NormalizedX, obj.NormalizedY,
                    floorPlan.ImageWidth, floorPlan.ImageHeight,
                    obj.Id.ToString(), obj.Type.Icon, obj.Type.Name, obj.Description, status);
            }

            // Set up click handler
            dotNetRef = DotNetObjectReference.Create(this);
            await module.InvokeVoidAsync("onMarkerClick", "inspectionMap", dotNetRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing map: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnObjectClicked(string objectId)
    {
        if (Guid.TryParse(objectId, out var id))
        {
            var obj = objects?.FirstOrDefault(o => o.Id == id);
            if (obj != null)
            {
                await InvokeAsync(() =>
                {
                    SelectObject(obj);
                    StateHasChanged();
                });
            }
        }
    }

    private void SelectObject(InspectionObject obj)
    {
        selectedObject = obj;
        currentResult = results.FirstOrDefault(r => r.ObjectId == obj.Id);
        
        if (currentResult != null)
        {
            inspectionForm.Status = currentResult.Status;
            inspectionForm.Comment = currentResult.Comment ?? string.Empty;
        }
        else
        {
            inspectionForm = new InspectionForm { Status = InspectionStatus.Ok };
        }
    }

    private void ClearSelection()
    {
        selectedObject = null;
        currentResult = null;
        inspectionForm = new InspectionForm { Status = InspectionStatus.Ok };
    }

    private void OnStatusChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<InspectionStatus>(e.Value?.ToString(), out var status))
        {
            inspectionForm.Status = status;
        }
    }

    private async Task SaveInspection()
    {
        if (selectedObject == null) return;

        using var context = await DbFactory.CreateDbContextAsync();

        // Check if already inspected
        var existingResult = await context.InspectionResults
            .FirstOrDefaultAsync(r => r.RoundId == RoundId && r.ObjectId == selectedObject.Id);

        if (existingResult != null)
        {
            // Update existing
            existingResult.Status = inspectionForm.Status;
            existingResult.Comment = inspectionForm.Comment;
            existingResult.Timestamp = DateTime.UtcNow;
        }
        else
        {
            // Create new
            var result = new InspectionResult
            {
                Id = Guid.NewGuid(),
                RoundId = RoundId,
                ObjectId = selectedObject.Id,
                Status = inspectionForm.Status,
                Comment = inspectionForm.Comment,
                Timestamp = DateTime.UtcNow
            };
            context.InspectionResults.Add(result);
        }

        await context.SaveChangesAsync();

        // Update marker on map
        if (module != null)
        {
            await module.InvokeVoidAsync("updateMarkerStatus", "inspectionMap",
                selectedObject.Id.ToString(), inspectionForm.Status);
        }

        // Reload data
        await LoadRound();
        ClearSelection();
        StateHasChanged();
    }

    private async Task CompleteRound()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        var roundToUpdate = await context.InspectionRounds.FindAsync(RoundId);
        
        if (roundToUpdate != null)
        {
            roundToUpdate.Status = InspectionRoundStatus.Completed;
            roundToUpdate.CompletedAt = DateTime.UtcNow;
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/Inspector/Rounds");
    }

    public async ValueTask DisposeAsync()
    {
        if (module != null)
        {
            await module.DisposeAsync();
        }
        dotNetRef?.Dispose();
    }

    private class InspectionForm
    {
        public InspectionStatus Status { get; set; } = InspectionStatus.Ok;
        public string Comment { get; set; } = string.Empty;
    }
}
