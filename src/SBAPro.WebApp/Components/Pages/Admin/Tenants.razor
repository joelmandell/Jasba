@page "/Admin/Tenants"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Localization
@using SBAPro.Core.Entities
@using SBAPro.Infrastructure.Data
@attribute [Authorize(Roles = "SystemAdmin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject IStringLocalizer<SharedResources> Localizer

<PageTitle>@Localizer["TenantManagement"] - @Localizer["AppName"]</PageTitle>

<h3>@Localizer["TenantManagement"]</h3>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="ShowCreateForm">@Localizer["CreateNewTenant"]</button>
</div>

@if (showCreateForm)
{
    <div class="card mb-3">
        <div class="card-header">@Localizer["CreateNewTenant"]</div>
        <div class="card-body">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">
                    @errorMessage
                </div>
            }
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">
                    @successMessage
                </div>
            }
            <EditForm Model="newTenant" OnValidSubmit="CreateTenant">
                <div class="mb-3">
                    <label class="form-label">@Localizer["TenantName"]</label>
                    <InputText class="form-control" @bind-Value="newTenant.Name" />
                </div>
                <div class="mb-3">
                    <label class="form-label">@Localizer["AdminEmail"]</label>
                    <InputText class="form-control" @bind-Value="newTenant.AdminEmail" />
                </div>
                <div class="mb-3">
                    <label class="form-label">@Localizer["AdminPassword"]</label>
                    <InputText type="password" class="form-control" @bind-Value="newTenant.AdminPassword" />
                </div>
                <button type="submit" class="btn btn-success">@Localizer["Create"]</button>
                <button type="button" class="btn btn-secondary" @onclick="() => showCreateForm = false">@Localizer["Cancel"]</button>
            </EditForm>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage) && !showCreateForm)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
    </div>
}
@if (!string.IsNullOrEmpty(successMessage) && !showCreateForm)
{
    <div class="alert alert-success alert-dismissible fade show">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
    </div>
}

@if (tenants != null)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@Localizer["Name"]</th>
                <th>@Localizer["ID"]</th>
                <th>@Localizer["Users"]</th>
                <th>@Localizer["Sites"]</th>
                <th>@Localizer["Actions"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var tenant in tenants)
            {
                var canDelete = tenant.Sites.Count == 0 && tenant.InspectionObjectTypes.Count == 0;
                <tr>
                    <td>@tenant.Name</td>
                    <td><small>@tenant.Id</small></td>
                    <td>@tenant.Users.Count</td>
                    <td>@tenant.Sites.Count</td>
                    <td>
                        @if (canDelete)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteTenant(tenant)">
                                @Localizer["Delete"]
                            </button>
                        }
                        else
                        {
                            <span class="text-muted small">@Localizer["HasData"]</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Tenant>? tenants;
    private bool showCreateForm = false;
    private CreateTenantModel newTenant = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTenants();
    }

    private async Task LoadTenants()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        tenants = await context.Tenants
            .IgnoreQueryFilters()
            .Include(t => t.Users)
            .Include(t => t.Sites)
            .Include(t => t.InspectionObjectTypes)
            .ToListAsync();
    }

    private async Task DeleteTenant(Tenant tenant)
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            int userCount = 0;
            string tenantName = tenant.Name;

            // First, verify tenant can be deleted
            using (var context = await DbFactory.CreateDbContextAsync())
            {
                var tenantToCheck = await context.Tenants
                    .IgnoreQueryFilters()
                    .Include(t => t.Users)
                    .Include(t => t.Sites)
                    .Include(t => t.InspectionObjectTypes)
                    .FirstOrDefaultAsync(t => t.Id == tenant.Id);

                if (tenantToCheck == null)
                {
                    errorMessage = "Tenant not found.";
                    return;
                }

                // Check if tenant has any sites or custom object types
                if (tenantToCheck.Sites.Any() || tenantToCheck.InspectionObjectTypes.Any())
                {
                    errorMessage = "Cannot delete tenant with existing sites or inspection object types. Please delete them first.";
                    return;
                }

                userCount = tenantToCheck.Users.Count;

                // Delete all users associated with this tenant (using UserManager which has its own context)
                if (tenantToCheck.Users.Any())
                {
                    foreach (var user in tenantToCheck.Users.ToList())
                    {
                        var deleteResult = await UserManager.DeleteAsync(user);
                        if (!deleteResult.Succeeded)
                        {
                            errorMessage = $"Failed to delete user {user.Email}: {string.Join(", ", deleteResult.Errors.Select(e => e.Description))}";
                            return;
                        }
                    }
                }
            }

            // After users are deleted, create a new context and delete the tenant
            using (var context = await DbFactory.CreateDbContextAsync())
            {
                var tenantToDelete = await context.Tenants
                    .IgnoreQueryFilters()
                    .FirstOrDefaultAsync(t => t.Id == tenant.Id);

                if (tenantToDelete == null)
                {
                    errorMessage = "Tenant not found.";
                    return;
                }

                context.Tenants.Remove(tenantToDelete);
                await context.SaveChangesAsync();
            }

            successMessage = $"Tenant '{tenantName}' and {userCount} user(s) deleted successfully.";
            await LoadTenants();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting tenant: {ex.Message}";
            Console.WriteLine($"Exception deleting tenant: {ex}");
        }
    }

    private void ShowCreateForm()
    {
        showCreateForm = true;
        newTenant = new CreateTenantModel();
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();
    }

    private async Task CreateTenant()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        
        try
        {
            Tenant tenant;
            
            // First, create the tenant
            using (var context = await DbFactory.CreateDbContextAsync())
            {
                tenant = new Tenant
                {
                    Id = Guid.NewGuid(),
                    Name = newTenant.Name
                };

                context.Tenants.Add(tenant);
                await context.SaveChangesAsync();
            }

            // Then, create the tenant admin user in a separate transaction
            // This ensures the tenant is fully committed before creating the user
            var adminUser = new ApplicationUser
            {
                UserName = newTenant.AdminEmail,
                Email = newTenant.AdminEmail,
                EmailConfirmed = true,
                TenantId = tenant.Id
            };

            var result = await UserManager.CreateAsync(adminUser, newTenant.AdminPassword);
            if (result.Succeeded)
            {
                await UserManager.AddToRoleAsync(adminUser, "TenantAdmin");
                successMessage = $"Tenant '{tenant.Name}' and admin user created successfully!";
                await Task.Delay(2000); // Show success message briefly
                showCreateForm = false;
                await LoadTenants();
            }
            else
            {
                // Show user creation errors
                errorMessage = "Failed to create admin user: " + string.Join(", ", result.Errors.Select(e => e.Description));
                
                // Also log to console for debugging
                foreach (var error in result.Errors)
                {
                    Console.WriteLine($"Error creating user: {error.Code} - {error.Description}");
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating tenant: {ex.Message}";
            Console.WriteLine($"Exception creating tenant: {ex}");
        }
    }

    public class CreateTenantModel
    {
        public string Name { get; set; } = string.Empty;
        public string AdminEmail { get; set; } = string.Empty;
        public string AdminPassword { get; set; } = string.Empty;
    }
}
